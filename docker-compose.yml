services:
  cronjob:
    build:
      context: ./app
      dockerfile: Dockerfile
    command: cron -f
    volumes:
      - ./app/:/usr/src/app/
    env_file:
      - ./.env
    environment:
      - RUNCRON=1
    depends_on:
      - db

  back:
    build:
      context: ./app
      dockerfile: Dockerfile
    command: python manage.py runserver 0.0.0.0:${WEB_PORT}
    volumes:
      - ./app/:/usr/src/app/
      - front_build:/usr/src/app/static/
    ports:
      - ${WEB_PORT}:${WEB_PORT}
    env_file:
      - ./.env
    environment:
      - RUNCRON=0
    depends_on:
      - db
      - redis
  
  websocket:
    build:
      context: ./app
      dockerfile: Dockerfile
    command: daphne -b 0.0.0.0 -p ${WS_PORT} parameters.asgi:application
    volumes:
      - ./app:/usr/src/app/
      - ./mediafiles:/usr/src/app/mediafiles/
    ports:
      - ${WS_PORT}:${WS_PORT}
    env_file:
      - ./.env
    environment:
      - RUNCRON=0
    depends_on:
      - db
      - redis

  front:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - front_build:/app/static/
    ports:
      - "3000:3000"
    command: npm run dev
    environment:
      - DEBUG=${DEBUG}
    depends_on:
      - back

  db:
    image: postgres:15.8
    ports:
      - $SQL_PORT:$SQL_PORT
    environment:
      - POSTGRES_USER=${SQL_USER} # user et mot de passe pour le super user postgres
      - POSTGRES_PASSWORD=${SQL_PASSWORD}
      - POSTGRES_DB=${SQL_DATABASE}
    volumes:
       - ./db-data/:/var/lib/postgresql/data/

  rabbitmq:
    image: rabbitmq:3-management  # Version avec interface de gestion
    ports:
      - ${RABBIT_MQ_PORT_AMQP}:${RABBIT_MQ_PORT_AMQP}    # Port pour AMQP
      - ${RABBIT_MQ_PORT_WEB}:${RABBIT_MQ_PORT_WEB}  # Port pour l'interface web de gestion
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBIT_MQ_USER}     # Utilisateur par défaut
      - RABBITMQ_DEFAULT_PASS=${RABBIT_MQ_PASSWORD}      # Mot de passe par défaut
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq # Persistance des données

  smtp:
    image: mailhog/mailhog
    ports:
      - "${EMAIL_SMTP_PORT}:${EMAIL_SMTP_PORT}"  # Port SMTP pour envoyer les emails
      - "8025:8025"  # Interface web de MailHog pour visualiser les emails

  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --requirepass "${REDIS_PASSWORD}"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}

  loki:
    image: grafana/loki:latest
    ports:
      - "${LOKI_PORT}:3100"
    volumes:
      - loki-data:/loki
      - ./loki-config.yml:/etc/loki/local-config.yaml
    command: -config.file=/etc/loki/local-config.yaml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports:
      - "${GRAFANA_PORT}:3000"
    env_file:
      - ./.env
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - grafana-provisioning:/etc/grafana/provisioning
    depends_on:
      - loki

  promtail:
    image: grafana/promtail:latest
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./app/logs:/app/logs:ro  # Montage des logs de votre application
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    restart: unless-stopped

volumes:
  db-data: null
  rabbitmq-data: null
  front_build: null
  redis-data: null
  grafana-data: null
  grafana-provisioning: null
  loki-data: null
